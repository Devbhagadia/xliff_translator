<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XLIFF Translator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* ✅ Progress Bar Styling */
        #progress-container {
            width: 100%;
            background: #ddd;
            height: 20px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }

        #progress-bar {
            height: 100%;
            background: #4caf50;
            width: 0%;
            border-radius: 5px;
            transition: width 0.3s;
        }

        /* ✅ Button container for Edit & Download */
        .button-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <h2 class="text-center">XLIFF Translator</h2>

        <!-- ✅ File Upload Form -->
        <form id="uploadForm" action="{% url 'upload_xliff' %}" method="POST" enctype="multipart/form-data" class="mt-4">
            {% csrf_token %}
            <div class="mb-3">
                <label for="xliffFile" class="form-label">Upload XLIFF File</label>
                <input type="file" class="form-control" name="xliff_file" id="xliffFile" required>
            </div>

            <!-- ✅ Language Selection Dropdown -->
            <div class="mb-3">
                <label for="languageSelect" class="form-label">Select Target Language</label>
                <select class="form-control" id="languageSelect" name="target_language">
                    <option value="abk">Abkhaz</option>
    <option value="ace">Acehnese</option>
    <option value="ach">Acholi</option>
    <option value="aar">Afar</option>
    <option value="af">Afrikaans</option>
    <option value="sq">Albanian</option>
    <option value="alz">Alur</option>
    <option value="am">Amharic</option>
    <option value="ar">Arabic</option>
    <option value="hy">Armenian</option>
    <option value="as">Assamese</option>
    <option value="ava">Avar</option>
    <option value="awa">Awadhi</option>
    <option value="ay">Aymara</option>
    <option value="az">Azerbaijani</option>
    <option value="ban">Balinese</option>
    <option value="bal">Baluchi</option>
    <option value="bm">Bambara</option>
    <option value="bci">Baoulé</option>
    <option value="bak">Bashkir</option>
    <option value="eu">Basque</option>
    <option value="btx">Batak Karo</option>
    <option value="bts">Batak Simalungun</option>
    <option value="bbc">Batak Toba</option>
    <option value="be">Belarusian</option>
    <option value="bem">Bemba</option>
    <option value="bn">Bengali</option>
    <option value="bew">Betawi</option>
    <option value="bho">Bhojpuri</option>
    <option value="bik">Bikol</option>
    <option value="bs">Bosnian</option>
    <option value="bre">Breton</option>
    <option value="bg">Bulgarian</option>
    <option value="bua">Buryat</option>
    <option value="yue">Cantonese</option>
    <option value="ca">Catalan</option>
    <option value="ceb">Cebuano</option>
    <option value="cha">Chamorro</option>
    <option value="che">Chechen</option>
    <option value="zh">Chinese</option>
    <option value="zh-cn">Chinese (Simplified)</option>
    <option value="zh-tw">Chinese (Traditional)</option>
    <option value="chk">Chuukese</option>
    <option value="chv">Chuvash</option>
    <option value="co">Corsican</option>
    <option value="crh">Crimean Tatar</option>
    <option value="hr">Croatian</option>
    <option value="cs">Czech</option>
    <option value="da">Danish</option>
    <option value="fa-af">Dari</option>
    <option value="dv">Dhivehi</option>
    <option value="din">Dinka</option>
    <option value="doi">Dogri</option>
    <option value="dom">Dombe</option>
    <option value="nl">Dutch</option>
    <option value="dyu">Dyula</option>
    <option value="dzo">Dzongkha</option>
    <option value="en">English</option>
    <option value="eo">Esperanto</option>
    <option value="et">Estonian</option>
    <option value="fao">Faroese</option>
    <option value="fij">Fijian</option>
    <option value="fil">Filipino (Tagalog)</option>
    <option value="fi">Finnish</option>
    <option value="fon">Fon</option>
    <option value="fr">French</option>
    <option value="fy">Frisian</option>
    <option value="fur">Friulian</option>
    <option value="ful">Fulani</option>
    <option value="gaa">Ga</option>
    <option value="gl">Galician</option>
    <option value="ka">Georgian</option>
    <option value="de">German</option>
    <option value="el">Greek</option>
    <option value="gn">Guarani</option>
    <option value="gu">Gujarati</option>
    <option value="ht">Haitian Creole</option>
    <option value="cnh">Hakha Chin</option>
    <option value="ha">Hausa</option>
    <option value="haw">Hawaiian</option>
    <option value="he">Hebrew</option>
    <option value="hil">Hiligaynon</option>
    <option value="hi">Hindi</option>
    <option value="hmn">Hmong</option>
    <option value="hu">Hungarian</option>
    <option value="iba">Iban</option>
    <option value="is">Icelandic</option>
    <option value="ig">Igbo</option>
    <option value="ilo">Ilocano</option>
    <option value="id">Indonesian</option>
    <option value="ga">Irish</option>
    <option value="it">Italian</option>
    <option value="ja">Japanese</option>
    <option value="jv">Javanese</option>
    <option value="kn">Kannada</option>
    <option value="kk">Kazakh</option>
    <option value="km">Khmer</option>
    <option value="kha">Khasi</option>
    <option value="kik">Kikongo</option>
    <option value="rw">Kinyarwanda</option>
    <option value="ktu">Kituba</option>
    <option value="trp">Kokborok</option>
    <option value="kom">Komi</option>
    <option value="gom">Konkani</option>
    <option value="ko">Korean</option>
    <option value="kri">Krio</option>
    <option value="ku">Kurdish</option>
    <option value="ckb">Kurdish (Sorani)</option>
    <option value="ky">Kyrgyz</option>
    <option value="lo">Lao</option>
    <option value="ltg">Latgalian</option>
    <option value="la">Latin</option>
    <option value="lv">Latvian</option>
    <option value="lij">Ligurian</option>
    <option value="lim">Limburgish</option>
    <option value="ln">Lingala</option>
    <option value="lt">Lithuanian</option>
    <option value="lmo">Lombard</option>
    <option value="lg">Luganda</option>
    <option value="luo">Luo</option>
    <option value="lb">Luxembourgish</option>
    <option value="mk">Macedonian</option>
    <option value="mad">Madurese</option>
    <option value="mai">Maithili</option>
    <option value="mak">Makassar</option>
    <option value="mg">Malagasy</option>
    <option value="ms">Malay</option>
    <option value="ms-arab">Malay (Jawi)</option>
    <option value="ml">Malayalam</option>
    <option value="mt">Maltese</option>
    <option value="mam">Mam</option>
    <option value="glv">Manx</option>
    <option value="mi">Maori</option>
    <option value="mr">Marathi</option>
    <option value="mah">Marshallese</option>
    <option value="mwr">Marwadi</option>
    <option value="mfe">Mauritian Creole</option>
    <option value="mhr">Meadow Mari</option>
    <option value="mni-mtei">Meiteilon (Manipuri)</option>
    <option value="min">Minang</option>
    <option value="lus">Mizo</option>
    <option value="mn">Mongolian</option>
    <option value="my">Myanmar (Burmese)</option>
    <option value="nhe">Nahuatl (Eastern Huasteca)</option>
    <option value="ndc-zw">Ndau</option>
    <option value="nde">Ndebele (South)</option>
    <option value="new">Nepalbhasa (Newari)</option>
    <option value="ne">Nepali</option>
    <option value="no">Norwegian</option>
    <option value="nus">Nuer</option>
    <option value="ny">Nyanja (Chichewa)</option>
    <option value="oci">Occitan</option>
    <option value="or">Odia (Oriya)</option>
    <option value="om">Oromo</option>
    <option value="oss">Ossetian</option>
    <option value="pag">Pangasinan</option>
    <option value="pap">Papiamento</option>
    <option value="ps">Pashto</option>
    <option value="fa">Persian</option>
    <option value="pl">Polish</option>
    <option value="por">Portuguese (Portugal)</option>
    <option value="pt">Portuguese (Portugal, Brazil)</option>
    <option value="pa">Punjabi</option>
    <option value="pa-arab">Punjabi (Shahmukhi)</option>
    <option value="kek">Q'eqchi'</option>
    <option value="qu">Quechua</option>
    <option value="rom">Romani</option>
    <option value="ro">Romanian</option>
    <option value="run">Rundi</option>
    <option value="ru">Russian</option>
    <option value="sme">Sami (North)</option>
    <option value="sm">Samoan</option>
    <option value="sag">Sango</option>
    <option value="sa">Sanskrit</option>
    <option value="sat">Santali</option>
    <option value="gd">Scots Gaelic</option>
    <option value="nso">Sepedi</option>
    <option value="sr">Serbian</option>
    <option value="st">Sesotho</option>
    <option value="crs">Seychellois Creole</option>
    <option value="shn">Shan</option>
    <option value="sn">Shona</option>
    <option value="scn">Sicilian</option>
    <option value="szl">Silesian</option>
    <option value="sd">Sindhi</option>
    <option value="si">Sinhala (Sinhalese)</option>
    <option value="sk">Slovak</option>
    <option value="sl">Slovenian</option>
    <option value="so">Somali</option>
    <option value="es">Spanish</option>
    <option value="su">Sundanese</option>
    <option value="sus">Susu</option>
    <option value="sw">Swahili</option>
    <option value="ssw">Swati</option>
    <option value="sv">Swedish</option>
    <option value="tl">Tagalog (Filipino)</option>
    <option value="tah">Tahitian</option>
    <option value="tg">Tajik</option>
    <option value="ber-atn">Tamazight</option>
    <option value="ber">Tamazight (Tifinagh)</option>
    <option value="ta">Tamil</option>
    <option value="tt">Tatar</option>
    <option value="te">Telugu</option>
    <option value="tet">Tetum</option>
    <option value="th">Thai</option>
    <option value="bod">Tibetan</option>
    <option value="ti">Tigrinya</option>
    <option value="tiv">Tiv</option>
    <option value="tpi">Tok Pisin</option>
    <option value="ton">Tongan</option>
    <option value="ts">Tsonga</option>
    <option value="tsn">Tswana</option>
    <option value="tcy">Tulu</option>
    <option value="tum">Tumbuka</option>
    <option value="tr">Turkish</option>
    <option value="tk">Turkmen</option>
    <option value="tuk">Tuvan</option>
    <option value="ak">Twi (Akan)</option>
    <option value="udm">Udmurt</option>
    <option value="uk">Ukrainian</option>
    <option value="ur">Urdu</option>
    <option value="ug">Uyghur</option>
    <option value="uz">Uzbek</option>
    <option value="ven">Venda</option>
    <option value="vec">Venetian</option>
    <option value="vi">Vietnamese</option>
    <option value="war">Waray</option>
    <option value="cy">Welsh</option>
    <option value="wol">Wolof</option>
    <option value="xh">Xhosa</option>
    <option value="sah">Yakut</option>
    <option value="yi">Yiddish</option>
    <option value="yo">Yoruba</option>
    <option value="yua">Yucatec Maya</option>
    <option value="zap">Zapotec</option>
    <option value="zu">Zulu</option>
                </select>
            </div>

            <button type="submit" class="btn btn-primary" id="translateBtn">Translate</button>

            <!-- ✅ Loader with Progress Bar -->
            <div id="loader" class="mt-3 text-center" style="display: none;">
                <p>Translating... <span id="progress-text">0%</span></p>
                <div id="progress-container">
                    <div id="progress-bar"></div>
                </div>
            </div>
        </form>

        <!-- ✅ Translations will be inserted dynamically here -->
        <div id="translations"></div>
    </div>

    <!-- ✅ JavaScript for Upload, Progress & Translation Handling -->
    <script>
        document.getElementById("uploadForm").addEventListener("submit", function (event) {
            event.preventDefault();  // ✅ Prevent default form submission

            let formData = new FormData(this);
            let selectedLanguage = document.getElementById("languageSelect").value;
            formData.append("target_language", selectedLanguage);  // ✅ Add language selection

            let translateBtn = document.getElementById("translateBtn");
            let loader = document.getElementById("loader");
            let progressContainer = document.getElementById("progress-container");

            translateBtn.style.display = "none";
            loader.style.display = "block";
            progressContainer.style.display = "block";

            fetch("{% url 'upload_xliff' %}", {  // ✅ Send file and language to Django backend
                method: "POST",
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert("Error: " + data.error);
                        translateBtn.style.display = "block";
                        loader.style.display = "none";
                        return;
                    }

                    showTranslatedTexts(data.translations, data.translated_file);  // ✅ Pass translated file name
                })
                .catch(error => console.error("Upload error:", error));
        });

        // ✅ Function to display translations dynamically
        function showTranslatedTexts(translations, translatedFileName) {
            console.log("Received Translated File Name:", translatedFileName);
            if (!translatedFileName) {
                console.error("No translated file available!");
                return;
            }
            let translationContainer = document.createElement("div");
            translationContainer.id = "translations";
            translationContainer.classList.add("mt-4");

            let heading = document.createElement("h4");
            heading.classList.add("text-center");
            heading.innerText = "Translation Preview";
            translationContainer.appendChild(heading);

            let table = document.createElement("table");
            table.classList.add("table", "table-bordered");

            let thead = document.createElement("thead");
            thead.classList.add("table-dark");
            thead.innerHTML = "<tr><th>Original Text</th><th>Translated Text (Editable)</th></tr>";
            table.appendChild(thead);

            let tbody = document.createElement("tbody");

            translations.forEach(entry => {
                let row = document.createElement("tr");

                let originalCell = document.createElement("td");
                originalCell.innerText = entry.original;

                let translatedCell = document.createElement("td");
                let input = document.createElement("input");
                input.type = "text";
                input.name = "translated_text[]";
                input.classList.add("form-control", "edit-field");
                input.value = entry.translated;
                input.setAttribute("disabled", true);

                translatedCell.appendChild(input);
                row.appendChild(originalCell);
                row.appendChild(translatedCell);
                tbody.appendChild(row);
            });

            table.appendChild(tbody);
            translationContainer.appendChild(table);

            let oldContainer = document.getElementById("translations");
            if (oldContainer) oldContainer.remove();

            document.querySelector(".container").appendChild(translationContainer);

            enableEditing();  
            enableDownload(translatedFileName);  
        }

        // ✅ Enable Editing on Click
        function enableEditing() {
            let editBtn = document.createElement("button");
            editBtn.id = "editBtn";
            editBtn.classList.add("btn", "btn-warning");
            editBtn.innerText = "Edit";
            editBtn.addEventListener("click", function () {
                document.querySelectorAll(".edit-field").forEach(input => input.removeAttribute("disabled"));
                saveBtn.style.display = "inline-block";
                editBtn.style.display = "none";
            });

            let saveBtn = document.createElement("button");
            saveBtn.id = "saveBtn";
            saveBtn.classList.add("btn", "btn-success");
            saveBtn.innerText = "Save Changes";
            saveBtn.style.display = "none";  

            let actionDiv = document.createElement("div");
            actionDiv.id = "actions";
            actionDiv.classList.add("button-container");

            actionDiv.appendChild(editBtn);
            actionDiv.appendChild(saveBtn);  

            let downloadLink = document.createElement("a");
            downloadLink.id = "downloadLink";
            downloadLink.classList.add("btn", "btn-success");
            downloadLink.innerText = "Download Translated File";
            downloadLink.setAttribute("download", "");
            downloadLink.style.display = "none";  

            actionDiv.appendChild(downloadLink);

            document.querySelector(".container").appendChild(actionDiv);
        }

        // ✅ Enable Download Button
        function enableDownload(translatedFileName) {
            console.log("Received translatedFileName:", translatedFileName);

            let downloadLink = document.getElementById("downloadLink");

            if (translatedFileName && translatedFileName.trim() !== "") {
                let fileName = translatedFileName.split('/').pop();  

                downloadLink.href = `/download/${fileName}/`;  
                downloadLink.style.display = "inline-block";  
            } else {
                console.error("Error: translatedFileName is empty or undefined!");
            }
        }
    </script>
</body>

</html>
